<assistant-operation>
    <div if="{!hidden}">
        <div class="container">
            <div class="row-fluid">
                <div class="col-md-3 col-xs-3 col-sm-3" >
                    <div class="well sidebar-nav" style="height: 38em">
                        <ul class="nav nav-list" style="margin-top: 1em">
                            <li class="leftlist" style="background: #e7e7e7"><a href="#assistant/query">助手号</a></li>

                        </ul>
                    </div><!--/.well -->
                </div><!--/span-->
                <div class="col-md-9 col-xs-9 col-sm-9">
                    <div class="jumbotron" style="min-height: 38em; overflow: hidden; padding-bottom: 0em">
                        <div class="panel panel-default container-fluid" style="min-height: 29em; padding-left: 1.1em">
                            <div id="dialog" style="padding-top: 1.5em; min-height: 29em; margin-bottom: 0em">
                                <div class="btn-group btn-group-justified topGroup" role="group" aria-label="...">
                                    <div class="btn-group" role="group">
                                        <button onclick="{baseInfo}" type="button" class="btn btn-default" style="background-color: #fff">基本信息</button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button onclick="{contacts}" type="button" class="btn btn-default" style="background-color: #EEE">联系人</button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button onclick="{mass}" type="button" class="btn btn-default" style="background-color: #EEE">群发</button>
                                    </div>
                                </div>
                                <div class="panel panel-default" style="min-height: 25em; margin-bottom: 0 !important;">
                                    <div class="operation" id="baseInfo" style="padding-top: 2em; text-align: center">
                                        <div class="col-md-8">
                                            <ul class="list-group" style="text-align: left">
                                                <li class="list-group-item">微信昵称:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{bot_nickname}</li>
                                                <li class="list-group-item">状态:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{bot_lFlg}</li>
                                                <li class="list-group-item">创建时间:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{bot_date}</li>
                                                <li class="list-group-item">备注:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{bot_remark}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="operation" id="contacts" style="width: 100%; display: none;">
                                        <div class="btn-group btn-group-justified contactsGroup" role="group" aria-label="...">
                                            <div class="btn-group" role="group">
                                                <button style="background-color: #fff" onclick="{single}" type="button" class="btn btn-default">个人</button>
                                            </div>
                                            <div class="btn-group" role="group">
                                                <button onclick="{group}" type="button" class="btn btn-default" style="background-color: #EEE">群</button>
                                            </div>
                                        </div>
                                        <div id="single" style="padding-top: 1em">
                                            <ul class="list-group">
                                                <li each="{contacts}" class="list-group-item"><img src="{bot_headimgid && (parent.api + '/file?media_id=' + bot_headimgid) || '../images/default_avatar.jpg'}" style="max-width: 2em" alt=""/> <span>{bot_nickname || '匿名'}</span></li>
                                            </ul>
                                        </div>
                                        <div id="group" style="display: none; padding-top: 1em">
                                            <ul class="list-group">
                                                <ul class="list-group">
                                                    <li each="{groups}" class="list-group-item"><span>{name || '匿名'}</span>
                                                    </li>
                                                </ul>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="operation" id="mass" style="height:auto; display: none;">
                                        <div class="btn-group btn-group-justified massGroup" role="group" aria-label="...">
                                            <div class="btn-group" role="group">
                                                <button style="background-color: #fff" onclick="{massToSingle}" type="button" class="btn btn-default">群发个人</button>
                                            </div>
                                            <div class="btn-group" role="group">
                                                <button onclick="{massToGroup}" type="button" class="btn btn-default" style="background-color: #EEE">群发群</button>
                                            </div>
                                        </div>
                                        <div id="massToSingle" style="padding-top: 1em">
                                            <span>&nbsp;&nbsp;历史消息:</span>
                                            <div if="{!singleBatchMsg}" class="panel panel-default" style="height: 3em; margin-top: 1em; line-height: 3em; text-align: center">
                                                <span>无纪录</span>
                                            </div>
                                            <div if="{singleBatchMsg}" class="panel panel-default" style="overflow-y: scroll; max-height: 15em; margin-top: 1em">
                                                <ul class="list-group">
                                                    <li each="{singleBatchMsg}" class="list-group-item">
                                                        <div style="height: 100%; width: 100%">
                                                            <div style="height: 3em;overflow: hidden; float: left; width: 70%;">{content}</div>
                                                            <div style="height: 3em; line-height: 3em; text-align: center">{parent.formatDate(crtOn)}</div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                            <textarea id="massToSingleMsg" style="margin-top: 2em;" class="form-control" rows="3"></textarea>
                                            <button type="button" onclick="{sendToSingle}" style="margin-left: 83%; margin-top: 1em; width: 7em; margin-right: 1em; margin-bottom: 1em;" class="btn btn-success">发送</button>
                                        </div>
                                        <div id="massToGroup" style="display: none; padding-top: 1em">
                                            <span>&nbsp;&nbsp;历史消息:</span>
                                            <div if="{!groupBatchMsg}" class="panel panel-default" style="height: 3em; line-height: 3em; margin-top: 1em; text-align: center">
                                                <span>无纪录</span>
                                            </div>
                                            <div if="{groupBatchMsg}" class="panel panel-default" style="overflow-y: scroll; max-height: 15em; margin-top: 1em">
                                                <ul class="list-group">
                                                    <li each="{groupBatchMsg}" class="list-group-item">
                                                        <div style="height: 100%; width: 100%">
                                                            <div style="height: 3em;overflow: hidden; float: left; width: 70%;">{content}</div>
                                                            <div style="height: 3em; line-height: 3em; text-align: center">{parent.formatDate(crtOn)}</div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                            <textarea id="massToGroupMsg" style="margin-top: 2em;" class="form-control" rows="3"></textarea>
                                            <button type="button" onclick="{sendToGroup}" style="margin-left: 83%; margin-top: 1em; width: 7em; margin-right: 1em; margin-bottom: 1em;" class="btn btn-success">发送</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr width="110%" style="margin-bottom: 0em ">
                            <input type="button" class="btn btn-primary" style="float: right; padding: 3px 12px; margin: 11px 0;" value="返回" onclick="{returnPage}"/>
                        </div>
                    </div>
                </div><!--/span-->;
            </div><!--/row-->


        </div><!--/container-->

        <style scoped>
            .leftlist{list-style-type: none;text-align: center;font-size: 1.3em}
        </style>
        <script>
            this.app = this.opts.app; //keep spa object
            var self = nest.presentable(this);
            self.env = (__app.settings.env.NODE_ENV=="production")?"public":"web";
            self.api =  __app.settings.api.url;
            var loadAssistantById = domain.action('loadAssistantById');
            var loadAssistantContacts = domain.action('loadAssistantContacts');
            var loadAssistantGroups = domain.action('loadAssistantGroups');
            var getBatchMsg = domain.action('getBatchMsg');
            var assistantMass = domain.action('assistantMass');

            var onLoadAssistantById = function(data){
                var createTime = new Date(data.crtOn);
                var year = createTime.getFullYear();
                var month = createTime.getMonth() + 1;
                var day = createTime.getDate();
                self.bot_date =  year + '-' + month + '-' + day;
                self.bot_nickname = data.nickname || '匿名';
                self.bot_remark = data.remark;
                self.bot_lFlg = data.lFlg;

                self.bot_id = data.bucketid + ':' + data.openid;
                self.botId = data._id;
                loadAssistantContacts.execute(self.bot_id);
                loadAssistantGroups.execute(data._id);
                getBatchMsg.execute(self.botId, 'single');
                getBatchMsg.execute(self.botId, 'group');
                self.update();
            }

            var onLoadAssistantContacts = function(data){
                if(data){
                    self.contacts = data;
                    self.update();
                }
            }

            var onLoadAssistantGroups = function(data){
                if(data){
                    self.groups = data;
                    self.update();
                }
            }

            var onAssistantMass = function(data){
                if(data.success){
                    $('#massToSingleMsg').val('');
                    $('#massToGroupMsg').val('');
                }else{
                    alert('发送失败')
                }
            }

            var onGetBatchMsg = function(data){
                if(data.batchMsg){
                    if(data.type === 'single'){
                        self.singleBatchMsg = data.batchMsg;
                    }else if(data.type === 'group'){
                        self.groupBatchMsg = data.batchMsg;
                    }
                    self.update();
                }
            }

            this.on('mount', function(){
                console.info('tag assistant mass is mounted');
                loadAssistantById.onDone(onLoadAssistantById);
                loadAssistantContacts.onDone(onLoadAssistantContacts);
                loadAssistantGroups.onDone(onLoadAssistantGroups);
                assistantMass.onDone(onAssistantMass);
                getBatchMsg.onDone(onGetBatchMsg);
            });
            this.on('unmount', function(){
                console.info('tag assistant mass is unmounted');
                loadAssistantById.offDone(onLoadAssistantById);
                loadAssistantContacts.offDone(onLoadAssistantContacts);
                loadAssistantGroups.offDone(onLoadAssistantGroups);
                assistantMass.offDone(onAssistantMass);
                getBatchMsg.offDone(onGetBatchMsg);
            });
            this.on('open', function(opts){
                console.info('tag cassistant mass is opening');
                self.trigger('ready', true);
                self.trigger('view-route-to');
                loadAssistantById.execute(opts._id);
            });

            this.on('leave', function(){
                self.mask = true;
                self.update();
            });

            this.on('reenter', function(){
                self.mask = false;
                self.update();
            });

            this.on('refresh', function(){
                console.info('tag assistant mass is refreshing');
                //_refresh();
            });

            self.formatDate = function(date){
                var dateStr = new Date(date).toLocaleDateString();
                return dateStr.replace(/\//g, '-');
            }

            returnPage(e){
                e.preventUpdate = true;
                riot.route('assistant/query');
            }

            function btnClickCommon(e, group){
                e.preventUpdate = true;
                $('.' + group + ' button').css('background-color', '#EEE');
                var target = e.currentTarget;
                $(target).css('background-color', '#fff');
                $(target).one('blur', function(){
                    $(target).css('background-color', '#fff');
                })
            }

            baseInfo(e){
                btnClickCommon(e , 'topGroup');
                $('.operation').hide();
                $('#baseInfo').show();
            }

            contacts(e){
                btnClickCommon(e , 'topGroup');
                $('.operation').hide();
                $('#contacts').show();
            }

            mass(e){
                btnClickCommon(e , 'topGroup');
                $('.operation').hide();
                $('#mass').show();
            }

            single(e){
                btnClickCommon(e , 'contactsGroup');
                $('#group').hide();
                $('#single').show();
            }

            group(e){
                btnClickCommon(e , 'contactsGroup');
                $('#single').hide();
                $('#group').show();
            }

            massToSingle(e){
                btnClickCommon(e , 'massGroup');
                $('#massToGroup').hide();
                $('#massToSingle').show();
            }

            massToGroup(e){
                btnClickCommon(e , 'massGroup');
                $('#massToSingle').hide();
                $('#massToGroup').show();
            }

            sendToSingle(e){
                e.preventUpdate = true;
                var msg = $('#massToSingleMsg').val().trim();
                if(msg.length > 0) {
                    var data = {
                        botId: self.botId,
                        bot_id: self.bot_id,
                        msg: msg,
                        type: 'single'
                    }
                    assistantMass.execute(data);
                }else{
                    alert('发送内容不能为空');
                }
            }

            sendToGroup(e){
                e.preventUpdate = true;
                var msg = $('#massToGroupMsg').val().trim();
                if(msg.length > 0) {
                    var data = {
                        botId: self.botId,
                        bot_id: self.bot_id,
                        msg: msg,
                        type: 'group'
                    }
                    assistantMass.execute(data);
                }else{
                    alert('发送内容不能为空');
                }
            }
        </script>
    </div>
</assistant-operation>